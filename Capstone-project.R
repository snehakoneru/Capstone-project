#Clearing out old variables
rm(list=ls())
setwd(dataPath)

#Loading dplyr and tidyr
library(tidyr)
library(dplyr)
library(lubridate)
library(janitor)
library(knitr)
library(reshape2)

#Read the .csv file
#NEVER: The estimated share of people in this county who would say never in response to the question “How often do you wear a mask in public when you expect to be within six feet of another person?”
#RARELY: The estimated share of people in this county who would say rarely
#SOMETIMES: The estimated share of people in this county who would say sometimes
#FREQUENTLY: The estimated share of people in this county who would say frequently
#ALWAYS: The estimated share of people in this county who would say always
mask<-read.csv("mask-use-by-county.csv", header=T, sep=",",comment.char = "#")
glimpse(mask)

mask_combine<-mask %>%
	mutate(yes = FREQUENTLY + ALWAYS)%>%
	mutate(no = NEVER + RARELY) %>%
	group_by(STATE)%>%
	mutate(YES = mean(yes))%>%
	mutate(NO = mean(no))%>%
	select(STATE, YES, NO)

mask_state<-as.data.frame(unique(mask_combine))
mask_state<-mask_state[-3,]

#Time Series of Diagnostic testing
test<-read.csv("COVID-19_Diagnostic_Laboratory_Testing__PCR_Testing__Time_Series.csv", header=T, sep=",",comment.char = "#")
glimpse(test)


test_date<-as.POSIXct(test$date)
test_year<-lubridate::year(test_date)
test_mon<-lubridate::month(test_date)

test_july_20 <- test %>%
	cbind(test_date,test_year,test_mon) %>%
	filter(test_year == "2020")%>%
	filter(test_mon == 7)%>%
	filter(overall_outcome =="Positive")%>%
	mutate(positivity = (new_results_reported/total_results_reported)*100)%>%
	group_by(state)%>%
	mutate(mean_positivity_percent = mean(positivity))%>%
	select(state, mean_positivity_percent)

test_state<-as.data.frame(unique(test_july_20))

test_state_reorder<-test_state[match(mask_state$STATE,test_state$state),]

pacol<-read.csv("US_state_party_color.csv", header=T, sep=",",comment.char = "#")
party_color<- pacol$party_color[match(pacol$State,test_state_reorder$state)]

new.df<-cbind(mask_state,test_state_reorder,party_color)

new.df.asc<- new.df %>% 
	arrange (desc(mean_positivity_percent))

#Correlation between mask wearing and test positive in July 2020
mod <- lm(YES~mean_positivity_percent, data=new.df.asc)

summary(mod)
plot(YES~mean_positivity_percent,col="lightblue",pch=19,cex=2,data=new.df.asc)
abline(mod,col="red",lwd=3)
legend("topright",legend=paste("R2 is", format(summary(mod)$r.squared,digits=2)))
text(YES~mean_positivity_percent, labels=state,data=new.df.asc, cex=0.9, font=2)


#Correlation between no mask wearing and test positive in July 2020
mod <- lm(NO~mean_positivity_percent, data=new.df.asc)

summary(mod)
plot(NO~mean_positivity_percent,col="lightblue",pch=19,cex=2,data=new.df.asc)
abline(mod,col="red",lwd=3)
legend("topright",legend=paste("R2 is", format(summary(mod)$r.squared,digits=2)))
text(NO~mean_positivity_percent, labels=state,data=new.df.asc, cex=0.9, font=2)



#Johns Hopkins time series confirmed covid cases data
conf <- read.csv("time_series_covid19_confirmed_US.csv", header=T, sep=",",comment.char = "#")

conf.ca <-read.csv("time_series_covid19_confirmed_daily_CA.csv", header=T, sep=",",comment.char = "#",check.names=FALSE)

library(ggplot2)
library(dplyr) # easier data wrangling 
library(viridis) # colour blind friendly palette, works in B&W also
library(lubridate) # for easy date manipulation
library(ggExtra) # because remembering ggplot theme options is beyond me
library(tidyr) 

ca<-conf.ca[,c(5,6,8,13:584)]
ca.l<-gather(ca,date,confirmed,"1/23/2020"  ,"1/24/2020"  ,"1/25/2020"  ,"1/26/2020" , "1/27/2020" , "1/28/2020" , "1/29/2020" , "1/30/2020" , "1/31/2020" , "02/01/2020", "02/02/2020", "02/03/2020", "02/04/2020", "02/05/2020", "02/06/2020", "02/07/2020", "02/08/2020", "02/09/2020", "02/10/2020", "02/11/2020", "02/12/2020", "2/13/2020" , "2/14/2020" , "2/15/2020" , "2/16/2020" , "2/17/2020" , "2/18/2020" , "2/19/2020" , "2/20/2020" , "2/21/2020" , "2/22/2020" , "2/23/2020" , "2/24/2020" , "2/25/2020" , "2/26/2020" , "2/27/2020" , "2/28/2020" , "2/29/2020" , "03/01/2020", "03/02/2020", "03/03/2020", "03/04/2020", "03/05/2020", "03/06/2020", "03/07/2020", "03/08/2020", "03/09/2020", "03/10/2020", "03/11/2020", "03/12/2020", "3/13/2020" , "3/14/2020" , "3/15/2020" , "3/16/2020" , "3/17/2020" , "3/18/2020" , "3/19/2020" , "3/20/2020" , "3/21/2020" , "3/22/2020" , "3/23/2020" , "3/24/2020" , "3/25/2020" , "3/26/2020" , "3/27/2020" , "3/28/2020" , "3/29/2020" , "3/30/2020" , "3/31/2020" , "04/01/2020", "04/02/2020", "04/03/2020", "04/04/2020", "04/05/2020", "04/06/2020", "04/07/2020", "04/08/2020", "04/09/2020", "04/10/2020", "04/11/2020", "04/12/2020", "4/13/2020" , "4/14/2020" , "4/15/2020" , "4/16/2020" , "4/17/2020" , "4/18/2020" , "4/19/2020" , "4/20/2020" , "4/21/2020" , "4/22/2020" , "4/23/2020" , "4/24/2020" , "4/25/2020" , "4/26/2020" , "4/27/2020" , "4/28/2020" , "4/29/2020" , "4/30/2020" , "05/01/2020", "05/02/2020", "05/03/2020", "05/04/2020", "05/05/2020", "05/06/2020", "05/07/2020", "05/08/2020", "05/09/2020", "05/10/2020", "05/11/2020", "05/12/2020", "5/13/2020" , "5/14/2020" , "5/15/2020" , "5/16/2020" , "5/17/2020" , "5/18/2020" , "5/19/2020" , "5/20/2020" , "5/21/2020" , "5/22/2020" , "5/23/2020" , "5/24/2020" , "5/25/2020" , "5/26/2020" , "5/27/2020" , "5/28/2020" , "5/29/2020" , "5/30/2020" , "5/31/2020" , "06/01/2020", "06/02/2020", "06/03/2020", "06/04/2020", "06/05/2020", "06/06/2020", "06/07/2020", "06/08/2020", "06/09/2020", "06/10/2020", "06/11/2020", "06/12/2020", "6/13/2020" , "6/14/2020" , "6/15/2020" , "6/16/2020" , "6/17/2020" , "6/18/2020" , "6/19/2020" , "6/20/2020" , "6/21/2020" , "6/22/2020" , "6/23/2020" , "6/24/2020" , "6/25/2020" , "6/26/2020" , "6/27/2020" , "6/28/2020" , "6/29/2020" , "6/30/2020" , "07/01/2020", "07/02/2020", "07/03/2020", "07/04/2020", "07/05/2020", "07/06/2020", "07/07/2020", "07/08/2020", "07/09/2020", "07/10/2020", "07/11/2020", "07/12/2020", "7/13/2020" , "7/14/2020" , "7/15/2020" , "7/16/2020" , "7/17/2020" , "7/18/2020" , "7/19/2020" , "7/20/2020" , "7/21/2020" , "7/22/2020" , "7/23/2020" , "7/24/2020" , "7/25/2020" , "7/26/2020" , "7/27/2020" , "7/28/2020" , "7/29/2020" , "7/30/2020" , "7/31/2020" , "08/01/2020", "08/02/2020", "08/03/2020", "08/04/2020", "08/05/2020", "08/06/2020", "08/07/2020", "08/08/2020", "08/09/2020", "08/10/2020", "08/11/2020", "08/12/2020", "8/13/2020" , "8/14/2020" , "8/15/2020" , "8/16/2020" , "8/17/2020" , "8/18/2020" , "8/19/2020" , "8/20/2020" , "8/21/2020" , "8/22/2020" , "8/23/2020" , "8/24/2020" , "8/25/2020" , "8/26/2020" , "8/27/2020" , "8/28/2020" , "8/29/2020" , "8/30/2020" , "8/31/2020" , "09/01/2020", "09/02/2020", "09/03/2020", "09/04/2020", "09/05/2020", "09/06/2020", "09/07/2020", "09/08/2020", "09/09/2020", "09/10/2020", "09/11/2020", "09/12/2020", "9/13/2020" , "9/14/2020" , "9/15/2020" , "9/16/2020" , "9/17/2020" , "9/18/2020" , "9/19/2020" , "9/20/2020" , "9/21/2020" , "9/22/2020" , "9/23/2020" , "9/24/2020" , "9/25/2020" , "9/26/2020" , "9/27/2020" , "9/28/2020" , "9/29/2020" , "9/30/2020" , "10/01/2020", "10/02/2020", "10/03/2020", "10/04/2020", "10/05/2020", "10/06/2020", "10/07/2020", "10/08/2020", "10/09/2020", "10/10/2020", "10/11/2020", "10/12/2020", "10/13/2020", "10/14/2020", "10/15/2020", "10/16/2020", "10/17/2020", "10/18/2020", "10/19/2020", "10/20/2020", "10/21/2020", "10/22/2020", "10/23/2020", "10/24/2020", "10/25/2020", "10/26/2020", "10/27/2020", "10/28/2020", "10/29/2020", "10/30/2020", "10/31/2020", "11/01/2020", "11/02/2020", "11/03/2020", "11/04/2020", "11/05/2020", "11/06/2020", "11/07/2020", "11/08/2020", "11/09/2020", "11/10/2020", "11/11/2020", "11/12/2020", "11/13/2020", "11/14/2020", "11/15/2020", "11/16/2020", "11/17/2020", "11/18/2020", "11/19/2020", "11/20/2020", "11/21/2020", "11/22/2020", "11/23/2020", "11/24/2020", "11/25/2020", "11/26/2020", "11/27/2020", "11/28/2020", "11/29/2020", "11/30/2020", "12/01/2020", "12/02/2020", "12/03/2020", "12/04/2020", "12/05/2020", "12/06/2020", "12/07/2020", "12/08/2020", "12/09/2020", "12/10/2020", "12/11/2020", "12/12/2020", "12/13/2020", "12/14/2020", "12/15/2020", "12/16/2020", "12/17/2020", "12/18/2020", "12/19/2020", "12/20/2020", "12/21/2020", "12/22/2020", "12/23/2020", "12/24/2020", "12/25/2020", "12/26/2020", "12/27/2020", "12/28/2020", "12/29/2020", "12/30/2020", "12/31/2020", "01/01/2021", "01/02/2021", "01/03/2021", "01/04/2021", "01/05/2021", "01/06/2021", "01/07/2021", "01/08/2021", "01/09/2021", "01/10/2021", "01/11/2021", "01/12/2021", "1/13/2021" , "1/14/2021" , "1/15/2021" , "1/16/2021" , "1/17/2021" , "1/18/2021" , "1/19/2021" , "1/20/2021" , "1/21/2021" , "1/22/2021" , "1/23/2021" , "1/24/2021" , "1/25/2021" , "1/26/2021" , "1/27/2021" , "1/28/2021" , "1/29/2021" , "1/30/2021" , "1/31/2021" , "02/01/2021", "02/02/2021", "02/03/2021", "02/04/2021", "02/05/2021", "02/06/2021", "02/07/2021", "02/08/2021", "02/09/2021", "02/10/2021", "02/11/2021", "02/12/2021", "2/13/2021" , "2/14/2021" , "2/15/2021" , "2/16/2021" , "2/17/2021" , "2/18/2021" , "2/19/2021" , "2/20/2021" , "2/21/2021" , "2/22/2021" , "2/23/2021" , "2/24/2021" , "2/25/2021" , "2/26/2021" , "2/27/2021" , "2/28/2021" , "03/01/2021", "03/02/2021", "03/03/2021", "03/04/2021", "03/05/2021", "03/06/2021", "03/07/2021", "03/08/2021", "03/09/2021", "03/10/2021", "03/11/2021", "03/12/2021", "3/13/2021" , "3/14/2021" , "3/15/2021" , "3/16/2021" , "3/17/2021" , "3/18/2021" , "3/19/2021" , "3/20/2021" , "3/21/2021" , "3/22/2021" , "3/23/2021" , "3/24/2021" , "3/25/2021" , "3/26/2021" , "3/27/2021" , "3/28/2021" , "3/29/2021" , "3/30/2021" , "3/31/2021" , "04/01/2021", "04/02/2021", "04/03/2021", "04/04/2021", "04/05/2021", "04/06/2021", "04/07/2021", "04/08/2021", "04/09/2021", "04/10/2021", "04/11/2021", "04/12/2021", "4/13/2021" , "4/14/2021" , "4/15/2021" , "4/16/2021" , "4/17/2021" , "4/18/2021" , "4/19/2021" , "4/20/2021" , "4/21/2021" , "4/22/2021" , "4/23/2021" , "4/24/2021" , "4/25/2021" , "4/26/2021" , "4/27/2021" , "4/28/2021" , "4/29/2021" , "4/30/2021" , "05/01/2021", "05/02/2021", "05/03/2021", "05/04/2021", "05/05/2021", "05/06/2021", "05/07/2021", "05/08/2021", "05/09/2021", "05/10/2021", "05/11/2021", "05/12/2021", "5/13/2021" , "5/14/2021" , "5/15/2021" , "5/16/2021" , "5/17/2021" , "5/18/2021" , "5/19/2021" , "5/20/2021" , "5/21/2021" , "5/22/2021" , "5/23/2021" , "5/24/2021" , "5/25/2021" , "5/26/2021" , "5/27/2021" , "5/28/2021" , "5/29/2021" , "5/30/2021" , "5/31/2021" , "06/01/2021", "06/02/2021", "06/03/2021", "06/04/2021", "06/05/2021", "06/06/2021", "06/07/2021", "06/08/2021", "06/09/2021", "06/10/2021", "06/11/2021", "06/12/2021", "6/13/2021" , "6/14/2021" , "6/15/2021" , "6/16/2021" , "6/17/2021" , "6/18/2021" , "6/19/2021" , "6/20/2021" , "6/21/2021" , "6/22/2021" , "6/23/2021" , "6/24/2021" , "6/25/2021" , "6/26/2021" , "6/27/2021" , "6/28/2021" , "6/29/2021" , "6/30/2021" , "07/01/2021", "07/02/2021", "07/03/2021", "07/04/2021", "07/05/2021", "07/06/2021", "07/07/2021", "07/08/2021", "07/09/2021", "07/10/2021", "07/11/2021", "07/12/2021", "7/13/2021" , "7/14/2021" , "7/15/2021" , "7/16/2021" , "7/17/2021" , "7/18/2021" , "7/19/2021" , "7/20/2021" , "7/21/2021" , "7/22/2021" , "7/23/2021" , "7/24/2021" , "7/25/2021" , "7/26/2021" , "7/27/2021" , "7/28/2021" , "7/29/2021" , "7/30/2021" , "7/31/2021" , "08/01/2021", "08/02/2021", "08/03/2021", "08/04/2021", "08/05/2021", "08/06/2021", "08/07/2021", "08/08/2021", "08/09/2021", "08/10/2021", "08/11/2021", "08/12/2021", "8/13/2021" , "8/14/2021" , "8/15/2021", "8/16/2021" )
ca.l$date<-as.Date(ca.l$date, format="%m/%d/%Y")
ca.l$confirmed<-abs(ca.l$confirmed)

ca.p <- ca.l %>% 
				mutate(year = year(date),
                  month = month(date, label=TRUE),
                  day = day(date)) %>%
				mutate(conf_per = (confirmed/Population)*100000)


#Plots by county
for (i in 1:length(unique(ca.p$FIPS))){
	df <- ca.p %>%
		filter(FIPS==unique(ca.p$FIPS)[i])
	county <-unique(ca.l$Admin2)[i]
	p <- ggplot(df, aes(day,month,fill=confirmed)) +
	geom_tile(color="white",size =0.1) + 
	scale_fill_viridis(name="confirmed COVID-19 cases")
	p <- p + facet_grid(year~month)
	p <-p + scale_x_continuous(breaks =c(1,10,20,31))
	p <-p + theme_minimal(base_size = 8)
	p <-p + labs(title= paste("Confirmed COVID-19 cases per 100000 in", county), x="Day", y="Month")
	p <-p + theme(legend.position = "bottom")+
	theme(plot.title=element_text(size = 14))+
  	theme(axis.text.y=element_text(size=6)) +
  	theme(strip.background = element_rect(colour="white"))+
  	theme(plot.title=element_text(hjust=0))+
  	theme(axis.ticks=element_blank())+
  	theme(axis.text=element_text(size=7))+
  	theme(legend.title=element_text(size=8))+
  	theme(legend.text=element_text(size=6))
  	ggsave(p, file = paste0("plot_",unique(ca.l$Admin2)[i],".png"),width=14,height=10,units="cm")
}

